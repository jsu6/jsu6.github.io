<!doctype html>
<meta charset="utf-8">
<title>Animation API Fingerprinting — Direct Output</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; padding:18px; max-width:1000px; }
  h1 { font-size:20px; margin-bottom:6px; }
  button { padding:8px 14px; margin:4px; border:1px solid #ccc; border-radius:6px; background:#fafafa; cursor:pointer; }
  table { border-collapse:collapse; width:100%; margin-top:10px; }
  th,td { border:1px solid #ddd; padding:4px 6px; font-size:13px; vertical-align:top; }
  th { background:#f5f5f5; text-align:left; }
  pre { background:#f9f9f9; border:1px solid #ddd; padding:8px; overflow:auto; max-height:220px; }
  #box { width:30px; height:30px; background:#69f; position:absolute; }
  #preview { width:120px; height:30px; background:#eee; overflow:hidden; position:relative; margin-top:8px; }
</style>

<h1>Animation API Fingerprinting — Direct Output</h1>
<p style="font-size:13px;color:#666">
Runs 10 rounds of the Animation API and records the raw outputs from key animation properties and methods.  
Differences across rounds or browsers may indicate fingerprintable timing behavior.
</p>

<div>
  <button id="runBtn">Run 10 Rounds</button>
  <span id="status" style="font-size:12px;margin-left:10px;">idle</span>
</div>

<div id="preview"><div id="box"></div></div>

<table id="summary">
<thead>
<tr>
<th>Round</th>
<th>startTime</th>
<th>playbackRate (after update)</th>
<th>getTiming().duration</th>
<th>getComputedTiming().progress</th>
<th>updateTiming() duration</th>
<th>timeline.getCurrentTime()</th>
<th>Worklet Registered</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h3>Raw Detail (last round)</h3>
<pre id="detail"></pre>

<script>
(async()=>{
const $=s=>document.querySelector(s);
const runBtn=$("#runBtn"),status=$("#status"),box=$("#box"),tbody=$("#summary tbody"),detail=$("#detail");

runBtn.onclick=async()=>{
  runBtn.disabled=true; tbody.innerHTML=""; detail.textContent=""; status.textContent="running…";
  for(let i=0;i<10;i++){
    const res=await runOnce(i);
    addRow(i,res);
    await new Promise(r=>setTimeout(r,200));
  }
  status.textContent="done";
  runBtn.disabled=false;
};

async function runOnce(i){
  // Create animation
  const anim=box.animate(
    [{transform:'translateX(0px)'},{transform:`translateX(${100+i*5}px)`}],
    {duration:800+Math.random()*200,easing:'ease-in-out'}
  );

  const result={round:i};
  await anim.ready.catch(()=>{});

  // Record startTime
  result.startTime=anim.startTime;

  // Update playback rate
  const newRate=1+Math.random()*0.5;
  anim.updatePlaybackRate(newRate);
  result.playbackRate=anim.playbackRate;

  // AnimationEffect methods
  const eff=anim.effect;
  result.getTiming=eff?.getTiming?.();
  result.getComputedTiming=eff?.getComputedTiming?.();

  // Update timing randomly
  const newDur=(result.getTiming?.duration||800)+Math.random()*150;
  eff?.updateTiming?.({duration:newDur});
  result.updateTimingDuration=newDur;

  // Timeline currentTime
  let timelineNow=null;
  try{
    timelineNow=document.timeline.getCurrentTime?.() ?? document.timeline.currentTime;
  }catch(e){timelineNow="error";}
  result.timelineTime=timelineNow;

  // AnimationWorkletGlobalScope.registerAnimator test
  let workletOk=false;
  if(CSS && "animationWorklet" in CSS && "addModule" in CSS.animationWorklet && window.WorkletAnimation){
    try{
      const src=`registerAnimator('dummy',class{animate(){} });`;
      const url=URL.createObjectURL(new Blob([src],{type:'text/javascript'}));
      await CSS.animationWorklet.addModule(url);
      workletOk=true;
    }catch{ workletOk=false; }
  }else{
    workletOk="n/a";
  }
  result.workletRegistered=workletOk;

  // Finish and cleanup
  try{await anim.finished;}catch{}
  anim.commitStyles?.();
  anim.cancel?.();

  // Output
  detail.textContent=JSON.stringify(result,null,2);
  return result;
}

function addRow(i,res){
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td>${i+1}</td>
    <td>${fmt(res.startTime)}</td>
    <td>${fmt(res.playbackRate)}</td>
    <td>${fmt(res.getTiming?.duration)}</td>
    <td>${fmt(res.getComputedTiming?.progress)}</td>
    <td>${fmt(res.updateTimingDuration)}</td>
    <td>${fmt(res.timelineTime)}</td>
    <td>${fmt(res.workletRegistered)}</td>`;
  tbody.appendChild(tr);
}

function fmt(x){
  if(x===undefined) return "n/a";
  if(x===null) return "null";
  if(typeof x==="number") return x.toFixed(3);
  return String(x);
}
})();
</script>
