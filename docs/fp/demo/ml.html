<!doctype html>
<html>
<body>
<button id="run">run</button>
<pre id="out"></pre>

<script>
const out = document.getElementById("out");

function h(a) {
  let x = 0;
  for (let v of a) x = (x * 31 + Math.fround(v * 1e6)) | 0;
  return (x >>> 0).toString(16);
}

async function run() {
  out.textContent = "";

  if (!navigator.ml) {
    out.textContent = "WebNN unavailable.";
    return;
  }

  const ctx = await navigator.ml.createContext();
  const b = new MLGraphBuilder(ctx);
  const results = {};

  async function test(name, fn, shape=[1,8]) {
    try {
      const desc = { dataType: "float32", shape };
      const input = b.input("x", desc);
      const size = shape.reduce((a,b)=>a*b, 1);

      const data = new Float32Array(size);
      for (let i=0;i<size;i++) data[i] = Math.sin(i*0.31);

      const outBuf = new Float32Array(size);

      const y = fn(b, input);
      const graph = await b.build({ out: y });

      const t0 = performance.now();
      await ctx.compute(graph, { x: data }, { out: outBuf });
      const t1 = performance.now();

      results[name] = {
        hash: h(outBuf),
        time: +(t1 - t0).toFixed(4)
      };
    } catch (e) {
      results[name] = { error: e.message };
    }
  }

  await test("relu", (b,x)=>b.relu(x));
  await test("tanh", (b,x)=>b.tanh(x));
  await test("sigmoid", (b,x)=>b.sigmoid(x));

  // linear: weightDesc must also use shape, not dimensions
  await test("linear", (b,x)=>{
    const W = new Float32Array(64);
    for (let i=0;i<64;i++) W[i] = Math.sin(i*0.17);

    const weightDesc = { dataType:"float32", shape:[8,8] };
    const biasDesc   = { dataType:"float32", shape:[8] };

    const Wc = b.constant(W, weightDesc);
    const Bc = b.constant(new Float32Array(8), biasDesc);
    return b.linear(x, Wc, { bias: Bc });
  });

  out.textContent = JSON.stringify(results, null, 2);
}

document.getElementById("run").onclick = run;
</script>
</body>
</html>
