<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebGPU Fingerprinting PoC (Fixed)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
<h2>WebGPU Fingerprinting (Fixed Version)</h2>
<div id="status"></div>

<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Condition</th>
      <th>Type</th>
      <th>Sample Value</th>
    </tr>
  </thead>
  <tbody id="out"></tbody>
</table>

<script>
async function run() {
  const out = document.getElementById("out");
  const status = document.getElementById("status");

  const add = (p, c, t, v) => {
    out.innerHTML += `
      <tr>
        <td>${p}</td>
        <td>${c}</td>
        <td>${t}</td>
        <td><pre>${v}</pre></td>
      </tr>`;
  };

  if (!navigator.gpu) {
    status.textContent = "WebGPU not supported.";
    return;
  }

  status.textContent = "Requesting adapter…";

  const adapter = await navigator.gpu.requestAdapter({
    powerPreference: "high-performance"
  });

  if (!adapter) {
    status.textContent = "No GPU adapter available.";
    return;
  }

  status.textContent = "Adapter acquired.";

  // ---- FIXED: requestAdapterInfo MUST be used; adapter.info is not implemented ----
  let infoValue = "unavailable";
  let infoType = "n/a";
  let infoCondition = "adapter.info not implemented in Chrome";

  if (typeof adapter.requestAdapterInfo === "function") {
    const info = await adapter.requestAdapterInfo({});
    infoValue = JSON.stringify(info, null, 2);
    infoType = typeof info;
    infoCondition = "returned via requestAdapterInfo()";
  }

  add("GPUAdapter.info", infoCondition, infoType, infoValue);

  // ---- FIXED: adapter.features is iterable directly ----
  const features = [...adapter.features];
  add(
    "GPUAdapter.features",
    "features supported: count=" + features.length,
    typeof adapter.features,
    JSON.stringify(features, null, 2)
  );

  // ---- FIXED: Chrome zero-limits bug → explicitly read limits ----
  const limitsObj = {};
  for (const key of Object.keys(adapter.limits)) {
    limitsObj[key] = adapter.limits[key];
  }

  add(
    "GPUAdapter.limits",
    "limits available: count=" + Object.keys(limitsObj).length,
    typeof adapter.limits,
    JSON.stringify(limitsObj, null, 2)
  );

  // ---- fallback adapter ----
  add(
    "GPUAdapter.isFallbackAdapter",
    "property present",
    typeof adapter.isFallbackAdapter,
    String(adapter.isFallbackAdapter)
  );

  // ---- compatibility mode ----
  add(
    "GPUAdapter.isCompatibilityMode",
    "property present",
    typeof adapter.isCompatibilityMode,
    String(adapter.isCompatibilityMode)
  );

  status.textContent = "Done.";
}

run();
</script>
</body>
</html>
