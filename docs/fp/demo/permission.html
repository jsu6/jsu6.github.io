<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>FileSystem / IdleDetector / Notification Fingerprinting Demo (Educational)</title>
<body style="font-family:system-ui;padding:1rem;white-space:pre-wrap">
<h2>Educational Fingerprinting Surface Demo</h2>
<p>This demo shows how APIs can expose local state or configuration differences.<br>
Click <b>Run Demo</b> to test FileSystem and Notification APIs.<br>
Use <b>Start IdleDetector</b> / <b>Stop IdleDetector</b> to see activity state changes.</p>

<button id="run">Run Demo</button>
<button id="startIdle">Start IdleDetector</button>
<button id="stopIdle">Stop IdleDetector</button>

<pre id="out">Ready...</pre>

<script>
const log = (...a) => out.textContent += a.join(' ') + '\n';

/* ---------- File System + Notification from before ---------- */
document.getElementById('run').onclick = async () => {
  out.textContent = '';

  if ('showOpenFilePicker' in window) {
    try {
      const [handle] = await showOpenFilePicker();
      log('[FileSystemHandle]');
      log('name:', handle.name);
      log('kind:', handle.kind);
      if ('getUniqueId' in handle) log('uniqueId:', await handle.getUniqueId());
      if ('queryPermission' in handle) log('queryPermission:', await handle.queryPermission({mode:'readwrite'}));
      if ('requestPermission' in handle) log('requestPermission:', await handle.requestPermission({mode:'readwrite'}));
      const f = await handle.getFile();
      log('file:', f.name, f.type, f.size, f.lastModified);
    } catch(e) { log('FileSystem error:', e.message); }
  } else {
    log('FileSystem Access API not supported.');
  }

  log('');

  if ('Notification' in window) {
    log('[Notification]');
    log('maxActions:', Notification.maxActions);
    log('current permission:', Notification.permission);
    if (Notification.permission !== 'granted') {
      const perm = await Notification.requestPermission();
      log('requestPermission() ->', perm);
    }
    if (Notification.permission === 'granted') {
      const n = new Notification('Demo', { body: 'Example body', tag: 'demoTag' });
      log('Notification shown with tag:', n.tag);
    }
  } else log('Notification API not supported.');

  log('');
};

/* ---------- Improved IdleDetector Section ---------- */
let controller = null;

const startButton = document.getElementById('startIdle');
const stopButton = document.getElementById('stopIdle');

startButton.addEventListener("click", async () => {
  controller = new AbortController();
  const signal = controller.signal;

  if (!('IdleDetector' in window)) {
    log('IdleDetector not supported.');
    return;
  }

  const perm = await IdleDetector.requestPermission();
  if (perm !== "granted") {
    log("Idle detection permission denied.");
    return;
  }

  try {
    const idleDetector = new IdleDetector();
    idleDetector.addEventListener("change", () => {
      const userState = idleDetector.userState;
      const screenState = idleDetector.screenState;
      log(`[IdleDetector] change: user=${userState}, screen=${screenState}`);
    });

    await idleDetector.start({
      threshold: 3_000, // 1 minute idle threshold
      signal,
    });
    log("IdleDetector is active. Move or lock screen to trigger changes.");
  } catch (err) {
    log("IdleDetector error:", err.name, err.message);
  }
});

stopButton.addEventListener("click", () => {
  if (controller) {
    controller.abort();
    log("IdleDetector stopped.");
  } else {
    log("No IdleDetector active.");
  }
});
</script>
</body>
</html>
