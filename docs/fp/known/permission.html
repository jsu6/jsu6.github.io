<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DeviceOrientation Permission Demo</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    #status { margin-bottom: 1rem; font-weight: bold; }
    .value { font-family: monospace; }
    button { padding: 0.5rem 1rem; margin-right: 0.5rem; }
  </style>
</head>
<body>
  <h1>DeviceOrientationEvent with Permission Status</h1>

  <div id="status">Checking support...</div>
  <button id="check">Check Permission</button>
  <button id="start">Start Listening</button>
  <button id="stop" disabled>Stop</button>

  <h2>Values</h2>
  <p>alpha (z-axis): <span id="alpha" class="value">—</span></p>
  <p>beta (x-axis): <span id="beta" class="value">—</span></p>
  <p>gamma (y-axis): <span id="gamma" class="value">—</span></p>

  <script>
    const statusEl = document.getElementById('status');
    const alphaEl  = document.getElementById('alpha');
    const betaEl   = document.getElementById('beta');
    const gammaEl  = document.getElementById('gamma');
    const checkBtn = document.getElementById('check');
    const startBtn = document.getElementById('start');
    const stopBtn  = document.getElementById('stop');

    let handler = null;
    let listening = false;

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function updateValues(e) {
      alphaEl.textContent = e.alpha != null ? e.alpha.toFixed(2) : 'null';
      betaEl.textContent  = e.beta  != null ? e.beta.toFixed(2)  : 'null';
      gammaEl.textContent = e.gamma != null ? e.gamma.toFixed(2) : 'null';
    }

    async function checkPermission() {
      if (typeof DeviceOrientationEvent === 'undefined') {
        setStatus('DeviceOrientationEvent not supported in this browser.');
        return;
      }

      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
          // Check current permission state
          const state = await navigator.permissions.query({ name: 'accelerometer' }).catch(() => null);
          if (state) {
            setStatus(`Permission state for motion sensors: ${state.state}`);
            return;
          }
          setStatus('Permission state unavailable; will require user gesture on Start.');
        } catch (err) {
          setStatus('Could not check permission: ' + err);
        }
      } else {
        setStatus('Non-iOS browser: permission not required.');
      }
    }

    async function startListening() {
      if (listening) return;

      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
          const result = await DeviceOrientationEvent.requestPermission();
          if (result === 'granted') {
            window.addEventListener('deviceorientation', handler = updateValues, true);
            listening = true;
            setStatus('Listening for deviceorientation events… (permission granted)');
            startBtn.disabled = true;
            stopBtn.disabled = false;
          } else {
            setStatus('Permission denied for DeviceOrientationEvent.');
          }
        } catch (err) {
          setStatus('Error requesting permission: ' + err);
        }
      } else {
        // No permission prompt needed (Android/desktop)
        window.addEventListener('deviceorientation', handler = updateValues, true);
        listening = true;
        setStatus('Listening for deviceorientation events…');
        startBtn.disabled = true;
        stopBtn.disabled = false;
      }
    }

    function stopListening() {
      if (!listening || !handler) return;
      window.removeEventListener('deviceorientation', handler, true);
      listening = false;
      handler = null;
      setStatus('Stopped listening.');
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    checkBtn.addEventListener('click', checkPermission);
    startBtn.addEventListener('click', startListening);
    stopBtn.addEventListener('click', stopListening);

    setStatus('Ready. Click "Check Permission" or "Start".');
  </script>
</body>
</html>
